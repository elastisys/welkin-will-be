
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Compliant Kubernetes is a Kubernetes distribution that reduces the burden for complying with Swedish Healthcare (Patientdatalagen), GDPR and ISO 27001.">
      
      
        <meta name="author" content="Elastisys AB">
      
      
        <link rel="canonical" href="https://elastisys.io/compliantkubernetes/operator-manual/azure/">
      
      
      
      <link rel="icon" href="../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.4">
    
    
      
        <title>Azure - Elastisys Compliant Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.240905d7.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
    
    
      <link rel="stylesheet" href="../../stylesheets/branding.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    

<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://matomo.elastisys.com/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '2']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

    
    
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data:;
  connect-src 'self' https://matomo.elastisys.com/;
  script-src 'self' 'unsafe-inline' https://matomo.elastisys.com/;
">

<!-- Disable localStorage, sessionStorage and cookies -->
<script>
if (window.localStorage) {
  window.localStorage.setItem = function() { };
  window.localStorage.clear();
}
if (window.sessionStorage) {
  window.sessionStorage.setItem = function() { }
  window.sessionStorage.clear();
}
if(!document.__defineGetter__) {
  Object.defineProperty(document, 'cookie', {
    get: function(){return ''},
    set: function(){return true},
  });
} else {
  document.__defineGetter__("cookie", function() { return '';} );
  document.__defineSetter__("cookie", function() {} );
}
</script>

  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="elastisys" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Elastisys Compliant Kubernetes" class="md-header__button md-logo" aria-label="Elastisys Compliant Kubernetes" data-md-component="logo">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Elastisys Compliant Kubernetes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Azure
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        

<ul class="header-links">
  <li>
    <a href="https://github.com/elastisys/compliantkubernetes/">
      <img width="25px" src="../../img/git-alt.svg" alt="Git logo" />
    </a>
  </li>
  <li><a href="https://elastisys.com/" class="menu-callout">Try out Managed<br/>Compliant Kubernetes</a></li>
</ul>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Elastisys Compliant Kubernetes" class="md-nav__button md-logo" aria-label="Elastisys Compliant Kubernetes" data-md-component="logo">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    Elastisys Compliant Kubernetes
  </label>
  
    <div class="md-nav__source">
      

<ul class="header-links">
  <li>
    <a href="https://github.com/elastisys/compliantkubernetes/">
      <img width="25px" src="../../img/git-alt.svg" alt="Git logo" />
    </a>
  </li>
  <li><a href="https://elastisys.com/" class="menu-callout">Try out Managed<br/>Compliant Kubernetes</a></li>
</ul>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          For Application Developers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          For Application Developers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/prepare/" class="md-nav__link">
        Step 1: Prepare
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/deploy/" class="md-nav__link">
        Step 2: Deploy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/operate/" class="md-nav__link">
        Step 3: Operate
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          Go Deeper
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Go Deeper
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/prepare-application/" class="md-nav__link">
        Prepare Your Application
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/registry/" class="md-nav__link">
        Container registry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/continous-development/" class="md-nav__link">
        Continous Development
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/network-model/" class="md-nav__link">
        Network Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/kubernetes-api/" class="md-nav__link">
        Kubernetes API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/kubernetes-ui/" class="md-nav__link">
        Kubernetes UI (Lens)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/namespaces/" class="md-nav__link">
        Namespaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/logs/" class="md-nav__link">
        Logs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/log-based-alerts/" class="md-nav__link">
        Log-based Alerts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/long-term-log-retention/" class="md-nav__link">
        Long-term Log Retention
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/metrics/" class="md-nav__link">
        Metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/alerts/" class="md-nav__link">
        Metric Alerts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/maintenance/" class="md-nav__link">
        Maintenance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/backup/" class="md-nav__link">
        Backups
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/ci-cd/" class="md-nav__link">
        CI/CD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/demarcation/" class="md-nav__link">
        Demarcation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/delegation/" class="md-nav__link">
        How to Delegate
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/how-many-environments/" class="md-nav__link">
        How many environments?
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          Safeguards
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Safeguards
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/safeguards/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/safeguards/enforce-no-root/" class="md-nav__link">
        Enforce No Root
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/safeguards/enforce-networkpolicies/" class="md-nav__link">
        Enforce NetworkPolicies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/safeguards/enforce-resources/" class="md-nav__link">
        Enforce Resources
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/safeguards/enforce-trusted-registries/" class="md-nav__link">
        Enforce Trusted Registries
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/safeguards/enforce-no-latest-tag/" class="md-nav__link">
        Enforce No Latest Tag
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
          Additional Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Additional Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/additional-services/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/additional-services/postgresql/" class="md-nav__link">
        PostgreSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/additional-services/timescaledb/" class="md-nav__link">
        TimescaleDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/additional-services/redis/" class="md-nav__link">
        Redis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/additional-services/rabbitmq/" class="md-nav__link">
        RabbitMQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/additional-services/jaeger/" class="md-nav__link">
        Jaeger
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/go-live/" class="md-nav__link">
        Go-live Checklist
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          For Kubernetes Administrators
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          For Kubernetes Administrators
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../provider-audit/" class="md-nav__link">
        Provider Audit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../on-prem-standard/" class="md-nav__link">
        Standard Template for on-prem Environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../qa/" class="md-nav__link">
        QA
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
      
      
      
        <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
          Advanced Configuration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_6">
          <span class="md-nav__icon md-icon"></span>
          Advanced Configuration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configure/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-sizing/" class="md-nav__link">
        Sizing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ingress/" class="md-nav__link">
        Ingress
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../access-control/" class="md-nav__link">
        Access Control
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../user-alerts/" class="md-nav__link">
        User Alerts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../disaster-recovery/" class="md-nav__link">
        Disaster Recovery
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../break-glass/" class="md-nav__link">
        Breaking the Glass
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/" class="md-nav__link">
        Use of Cryptography
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../credentials/" class="md-nav__link">
        Use of Credentials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../capacity-management/" class="md-nav__link">
        Capacity Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../maintenance/" class="md-nav__link">
        Maintenance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          For CISOs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          For CISOs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/controls/iso-27001/" class="md-nav__link">
        ISO 27001
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/controls/hslf-fs-201640/" class="md-nav__link">
        HSLF-FS 2016:40
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/controls/msbfs-20207/" class="md-nav__link">
        MSBFS 2020:7
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/controls/gdpr/" class="md-nav__link">
        GDPR
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/controls/hipaa/" class="md-nav__link">
        HIPAA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/controls/bsi-it-grundschutz/" class="md-nav__link">
        BSI IT-Grundschutz
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_8" >
      
      
      
        <label class="md-nav__link" for="__nav_4_8" id="__nav_4_8_label" tabindex="0">
          CISO Dashboards
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_8">
          <span class="md-nav__icon md-icon"></span>
          CISO Dashboards
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/audit-logs/" class="md-nav__link">
        Audit Logs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/backup/" class="md-nav__link">
        Backup Dashboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/cryptography/" class="md-nav__link">
        Cryptography Dashboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/intrusion-detection/" class="md-nav__link">
        Intrusion Detection Dashboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/policy-as-code/" class="md-nav__link">
        Policy-as-Code Dashboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/network-security/" class="md-nav__link">
        Network Security Dashboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/capacity-management/" class="md-nav__link">
        Capacity Management (Kubernetes Status) Dashboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/vulnerability/" class="md-nav__link">
        Vulnerability Dashboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/log-review/" class="md-nav__link">
        Log Review
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          For Contributors
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          For Contributors
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor-guide/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/" class="md-nav__link">
        Architectural Decision Log
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tech-radar/" class="md-nav__link">
        Tech Radar
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Release Notes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Release Notes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/ck8s/" class="md-nav__link">
        Compliant Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/kubespray/" class="md-nav__link">
        CK8S Kubespray
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/postgres/" class="md-nav__link">
        CK8S PostgreSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/rabbitmq/" class="md-nav__link">
        CK8S RabbitMQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/redis/" class="md-nav__link">
        CK8S Redis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/jaeger/" class="md-nav__link">
        CK8S Jaeger
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../roadmap/" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://elastisys.com/" class="md-nav__link">
        Support ⧉
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://elastisys.com/blog/" class="md-nav__link">
        Blog ⧉
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://elastisys.com/privacy-policy/" class="md-nav__link">
        Privacy Policy ⧉
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  



  
  


<div class="admonition bug">
<p class="admonition-title">This page is out of date</p>
<p>We are currently working on internal documentation to streamline
Compliant Kubernetes onboarding for selected cloud providers. Until
those documents are ready, and until we have capacity to make parts of
that documentation public, this page is out-of-date.</p>
<p>Nevertheless, parts of it are useful. Use at your own risk and don't expect things to work smoothly.</p>
</div>
<!--out-of-date-end-->

<h1 id="compliant-kubernetes-deployment-on-azure">Compliant Kubernetes Deployment on Azure<a class="headerlink" href="#compliant-kubernetes-deployment-on-azure" title="Permanent link">&para;</a></h1>
<p>This document contains instructions on how to setup a service cluster and a workload cluster in Azure.
The following are the main tasks addressed in this document:</p>
<ol>
<li>Infrastructure setup for two clusters: one service and one workload cluster</li>
<li>Deploying Compliant Kubernetes on top of the two clusters.</li>
<li>Creating DNS Records</li>
<li>Deploying Rook Storage Orchestration Service</li>
<li>Deploying Compliant Kubernetes apps</li>
</ol>
<p>Before starting, make sure you have <a href="../getting-started/">all necessary tools</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This guide is written for compliantkubernetes-apps <a href="https://github.com/elastisys/compliantkubernetes-apps/tree/v0.13.0">v0.13.0</a></p>
</div>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<p>Choose names for your service cluster and workload clusters, as well as the DNS domain to expose the services inside the service cluster:</p>
<div class="highlight"><pre><span></span><code><span class="nv">SERVICE_CLUSTER</span><span class="o">=</span><span class="s2">&quot;sc-test&quot;</span>
<span class="nv">WORKLOAD_CLUSTERS</span><span class="o">=(</span><span class="w"> </span><span class="s2">&quot;wc-test0&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="nv">BASE_DOMAIN</span><span class="o">=</span><span class="s2">&quot;example.com&quot;</span>
</code></pre></div>
<h2 id="infrastructure-setup-using-azurerm">Infrastructure Setup using AzureRM<a class="headerlink" href="#infrastructure-setup-using-azurerm" title="Permanent link">&para;</a></h2>
<p>We suggest to set up Kubernetes clusters using kubespray.
If you haven't done so already, clone the Elastisys Compliant Kubernetes Kubespray repo as follows:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>--recursive<span class="w"> </span>https://github.com/elastisys/compliantkubernetes-kubespray
<span class="nb">cd</span><span class="w"> </span>compliantkubernetes-kubespray
</code></pre></div>
<h3 id="install-azure-cli">Install azure-cli<a class="headerlink" href="#install-azure-cli" title="Permanent link">&para;</a></h3>
<p>If you haven't done so already, please install and configure <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">azure-cli</a>.</p>
<h3 id="login-with-azure-cli">Login with azure-cli<a class="headerlink" href="#login-with-azure-cli" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>az<span class="w"> </span>login
</code></pre></div>
<h3 id="customize-your-infrastructure">Customize your infrastructure<a class="headerlink" href="#customize-your-infrastructure" title="Permanent link">&para;</a></h3>
<p>Create a configuration for the service and the workload clusters:</p>
<div class="highlight"><pre><span></span><code><span class="nb">pushd</span><span class="w"> </span>kubespray/contrib/azurerm/
<span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>az<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span><span class="w"> </span>-l<span class="w"> </span>northeurope
<span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$CLUSTER</span>/inventory
<span class="k">done</span>
<span class="nb">popd</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please specify the value for the <code>ssh_public_keys</code> variable in <code>kubespray/contrib/azurerm/group_vars/all</code>.
It must be your SSH public key to access your Azure virtual machines.
Besides, the value for the <code>cluster_name</code> variable must be globally unique due to some restrictions in Azure.
Make sure that <code>$SERVICE_CLUSTER</code> and <code>$WORKLOAD_CLUSTERS</code> are unique.</p>
</div>
<p>Review and, if needed, adjust the files in <code>kubespray/contrib/azurerm/group_vars/all</code> accordingly.</p>
<h3 id="generate-and-apply-the-templates">Generate and apply the templates<a class="headerlink" href="#generate-and-apply-the-templates" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">pushd</span><span class="w"> </span>kubespray/contrib/azurerm/
<span class="nv">tmp</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">   </span>cat<span class="w"> </span>group_vars/all<span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>-e<span class="w"> </span><span class="s2">&quot;s@^cluster_name:.*@cluster_name: \&quot;</span><span class="nv">$CLUSTER</span><span class="s2">\&quot;@&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>&gt;<span class="w"> </span>group_vars/all1
<span class="w">   </span>cat<span class="w"> </span>group_vars/all1<span class="w"> </span>&gt;<span class="w"> </span>group_vars/all
<span class="w">   </span>rm<span class="w"> </span>group_vars/all1
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$tmp</span><span class="w"> </span><span class="o">]</span>
<span class="w">   </span><span class="k">then</span>
<span class="w">           </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}/{{ playbook_dir }}\/</span><span class="nv">$CLUSTER</span><span class="s2">/g&quot;</span><span class="w">  </span>roles/generate-templates/tasks/main.yml

<span class="w">           </span>ansible-playbook<span class="w"> </span>generate-templates.yml

<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/network.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/storage.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/availability-sets.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/bastion.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/masters.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/minions.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">           </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}\/</span><span class="nv">$tmp</span><span class="s2">/{{ playbook_dir }}\/</span><span class="nv">$CLUSTER</span><span class="s2">/g&quot;</span><span class="w">  </span>roles/generate-templates/tasks/main.yml

<span class="w">           </span>ansible-playbook<span class="w"> </span>generate-templates.yml

<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/network.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/storage.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/availability-sets.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/bastion.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/masters.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">           </span>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/minions.json<span class="w"> </span>-g<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">   </span><span class="k">fi</span>
<span class="w">   </span><span class="nv">tmp</span><span class="o">=</span><span class="nv">$CLUSTER</span>
<span class="w"> </span><span class="k">done</span>
<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}\/</span><span class="nv">$tmp</span><span class="s2">/{{ playbook_dir }}/g&quot;</span><span class="w">  </span>roles/generate-templates/tasks/main.yml
<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}\/</span><span class="nv">$tmp</span><span class="s2">/{{ playbook_dir }}/g&quot;</span><span class="w">  </span>roles/generate-inventory_2/tasks/main.yml
<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}\/</span><span class="nv">$tmp</span><span class="s2">/{{ playbook_dir }}/g&quot;</span><span class="w">  </span>roles/generate-inventory/tasks/main.yml
<span class="nb">popd</span>
</code></pre></div>
<h3 id="generating-an-inventory-for-kubespray">Generating an inventory for kubespray<a class="headerlink" href="#generating-an-inventory-for-kubespray" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">pushd</span><span class="w"> </span>kubespray/contrib/azurerm/
<span class="nv">tmp</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$tmp</span><span class="w"> </span><span class="o">]</span>
<span class="w">   </span><span class="k">then</span>
<span class="w">         </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}/{{ playbook_dir }}\/</span><span class="nv">$CLUSTER</span><span class="s2">/g&quot;</span><span class="w">  </span>roles/generate-inventory_2/tasks/main.yml
<span class="w">         </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}/{{ playbook_dir }}\/</span><span class="nv">$CLUSTER</span><span class="s2">/g&quot;</span><span class="w">  </span>roles/generate-inventory/tasks/main.yml
<span class="w">         </span>./generate-inventory.sh<span class="w"> </span><span class="nv">$CLUSTER</span>

<span class="w">   </span><span class="k">else</span>
<span class="w">           </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}\/</span><span class="nv">$tmp</span><span class="s2">/{{ playbook_dir }}\/</span><span class="nv">$CLUSTER</span><span class="s2">/g&quot;</span><span class="w">  </span>roles/generate-inventory_2/tasks/main.yml
<span class="w">           </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}\/</span><span class="nv">$tmp</span><span class="s2">/{{ playbook_dir }}\/</span><span class="nv">$CLUSTER</span><span class="s2">/g&quot;</span><span class="w">  </span>roles/generate-inventory/tasks/main.yml
<span class="w">           </span>./generate-inventory.sh<span class="w"> </span><span class="nv">$CLUSTER</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nv">tmp</span><span class="o">=</span><span class="nv">$CLUSTER</span>
<span class="k">done</span>
sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}\/</span><span class="nv">$tmp</span><span class="s2">/{{ playbook_dir }}/g&quot;</span><span class="w">  </span>roles/generate-inventory_2/tasks/main.yml
sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/{{ playbook_dir }}\/</span><span class="nv">$tmp</span><span class="s2">/{{ playbook_dir }}/g&quot;</span><span class="w">  </span>roles/generate-inventory/tasks/main.yml
<span class="nb">popd</span>
</code></pre></div>
<p>The inventory files for for cluster will be created under <code>*/inventory/</code>.
Besides, two <code>loadBalancer_vars.yaml</code> files will be created, one for each cluster.</p>
<p>You may also want to check the Azure portal if the infrastructure was created correctly.
The figure below shows for <code>wc-test0</code>.</p>
<p><img alt="Kubespray Azure for wc-test0" src="../../img/kubespray-azure-wc-sample.png" /></p>
<h2 id="deploying-vanilla-kubernetes-clusters-using-kubespray">Deploying vanilla Kubernetes clusters using Kubespray<a class="headerlink" href="#deploying-vanilla-kubernetes-clusters-using-kubespray" title="Permanent link">&para;</a></h2>
<p>With the infrastructure provisioned, we can now deploy Kubernetes using kubespray.
First, change to the <code>compliantkubernetes-kubespray</code> root directory.</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>..
</code></pre></div>
<h3 id="init-the-kubespray-config-in-your-config-path">Init the Kubespray config in your config path<a class="headerlink" href="#init-the-kubespray-config-in-your-config-path" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">CK8S_CONFIG_PATH</span><span class="o">=</span>~/.ck8s/azure
<span class="nb">export</span><span class="w"> </span><span class="nv">CK8S_PGP_FP</span><span class="o">=</span>&lt;your<span class="w"> </span>GPG<span class="w"> </span>key<span class="w"> </span>fingerprint&gt;<span class="w">  </span><span class="c1"># retrieve with gpg --list-secret-keys</span>

<span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>./bin/ck8s-kubespray<span class="w"> </span>init<span class="w"> </span><span class="nv">$CLUSTER</span><span class="w"> </span>default<span class="w"> </span><span class="nv">$CK8S_PGP_FP</span>
<span class="k">done</span>
</code></pre></div>
<h3 id="copy-the-generated-inventory-files-in-the-right-location">Copy the generated inventory files in the right location<a class="headerlink" href="#copy-the-generated-inventory-files-in-the-right-location" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="c1">#add calico to the inventory file</span>
<span class="w">  </span>cat<span class="w"> </span>kubespray/contrib/azurerm/<span class="nv">$CLUSTER</span>/inventory/inventory.j2<span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="p">|</span><span class="w"> </span>sed<span class="w">  </span><span class="s1">&#39;/\[k8s_cluster:children\]/i \[calico-rr\]&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>&gt;<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/<span class="nv">$CLUSTER</span>-config/inventory.ini
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;calico-rr&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/<span class="nv">$CLUSTER</span>-config/inventory.ini<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/<span class="nv">$CLUSTER</span>-config/inventory.ini
<span class="w">    </span><span class="c1"># Add ansible_user ubuntu (note that this assumes you have set admin_username in azurerm/group_vars/all to ubuntu)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;ansible_user: ubuntu&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/<span class="nv">$CLUSTER</span>-config/group_vars/k8s_cluster/ck8s-k8s_cluster.yaml

<span class="w">    </span><span class="c1"># Get the IP address of the loadbalancer (to be added in kubadmin certSANs list which will be used for kubectl)</span>
<span class="w">    </span><span class="nv">ip</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}&#39;</span><span class="w"> </span>kubespray/contrib/azurerm/<span class="nv">$CLUSTER</span>/loadbalancer_vars.yml<span class="k">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;supplementary_addresses_in_ssl_keys: [&quot;&#39;</span><span class="nv">$ip</span><span class="s1">&#39;&quot;]&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/<span class="nv">$CLUSTER</span>-config/group_vars/k8s_cluster/ck8s-k8s_cluster.yaml
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;nameservers:\n  - 1.1.1.1&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/<span class="nv">$CLUSTER</span>-config/group_vars/k8s_cluster/ck8s-k8s_cluster.yaml
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;resolvconf_mode: host_resolvconf&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/<span class="nv">$CLUSTER</span>-config/group_vars/k8s_cluster/ck8s-k8s_cluster.yaml

<span class="k">done</span>
</code></pre></div>
<h3 id="run-kubespray-to-deploy-the-kubernetes-clusters">Run kubespray to deploy the Kubernetes clusters<a class="headerlink" href="#run-kubespray-to-deploy-the-kubernetes-clusters" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>./bin/ck8s-kubespray<span class="w"> </span>apply<span class="w"> </span><span class="nv">$CLUSTER</span><span class="w"> </span>--flush-cache
<span class="k">done</span>
</code></pre></div>
<p>This may take up to 30 minutes per cluster.</p>
<p>Please increase the value for timeout, e.g <code>timeout=30</code>, in <code>kubespray/ansible.cfg</code> if you face the following issue while running step-3.</p>
<div class="highlight"><pre><span></span><code><span class="go">TASK [bootstrap-os : Fetch /etc/os-release] ****************************************************</span>
<span class="go">fatal: [minion-0]: FAILED! =&gt; {&quot;msg&quot;: &quot;Timeout (12s) waiting for privilege escalation prompt: &quot;}</span>
<span class="go">fatal: [minion-1]: FAILED! =&gt; {&quot;msg&quot;: &quot;Timeout (12s) waiting for privilege escalation prompt: &quot;}</span>
<span class="go">fatal: [minion-2]: FAILED! =&gt; {&quot;msg&quot;: &quot;Timeout (12s) waiting for privilege escalation prompt: &quot;}</span>
<span class="go">fatal: [master-0]: FAILED! =&gt; {&quot;msg&quot;: &quot;Timeout (12s) waiting for privilege escalation prompt: &quot;}</span>
</code></pre></div>
<h3 id="correct-the-kubernetes-api-ip-addresses">Correct the Kubernetes API IP addresses<a class="headerlink" href="#correct-the-kubernetes-api-ip-addresses" title="Permanent link">&para;</a></h3>
<p>Get the public IP address of the loadbalancer:</p>
<div class="highlight"><pre><span></span><code>grep<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}&#39;</span><span class="w"> </span>kubespray/contrib/azurerm/<span class="nv">$CLUSTER</span>/loadbalancer_vars.yml
</code></pre></div>
<p>Locate the encrypted kubeconfigs <code>kube_config_*.yaml</code> and edit them using sops.
Copy the IP shown above into <code>kube_config_*.yaml</code>. Do not overwrite the port.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>sops<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml
<span class="k">done</span>
</code></pre></div>
<h3 id="test-access-to-the-clusters-as-follows">Test access to the clusters as follows<a class="headerlink" href="#test-access-to-the-clusters-as-follows" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>sops<span class="w"> </span>exec-file<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s1">&#39;kubectl --kubeconfig {} get nodes&#39;</span>
<span class="k">done</span>
</code></pre></div>
<h3 id="deploy-rook">Deploy Rook<a class="headerlink" href="#deploy-rook" title="Permanent link">&para;</a></h3>
<p>To deploy Rook, please go to the <code>compliantkubernetes-kubespray</code> repo root directory and run the following.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>sops<span class="w"> </span>--decrypt<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$CLUSTER</span>.yaml
<span class="w">    </span><span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$CLUSTER</span>.yaml
<span class="w">    </span>./rook/deploy-rook.sh
<span class="w">    </span>shred<span class="w"> </span>-zu<span class="w"> </span><span class="nv">$CLUSTER</span>.yaml
<span class="k">done</span>
</code></pre></div>
<p>Please restart the operator pod, <code>rook-ceph-operator*</code>, if some pods stalls in initialization state as shown below:</p>
<div class="highlight"><pre><span></span><code><span class="go">rook-ceph     rook-ceph-crashcollector-minion-0-b75b9fc64-tv2vg    0/1     Init:0/2   0          24m</span>
<span class="go">rook-ceph     rook-ceph-crashcollector-minion-1-5cfb88b66f-mggrh   0/1     Init:0/2   0          36m</span>
<span class="go">rook-ceph     rook-ceph-crashcollector-minion-2-5c74ffffb6-jwk55   0/1     Init:0/2   0          14m</span>
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Pods in pending state usually indicate resource shortage. In such cases you need to use bigger instances.</p>
</div>
<h3 id="test-rook">Test Rook<a class="headerlink" href="#test-rook" title="Permanent link">&para;</a></h3>
<p>To test Rook, proceed as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>sops<span class="w"> </span>exec-file<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml<span class="w"> </span><span class="s1">&#39;kubectl --kubeconfig {} apply -f https://raw.githubusercontent.com/rook/rook/release-1.5/cluster/examples/kubernetes/ceph/csi/rbd/pvc.yaml&#39;</span><span class="p">;</span>
<span class="k">done</span>

<span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>sops<span class="w"> </span>exec-file<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml<span class="w"> </span><span class="s1">&#39;kubectl --kubeconfig {} get pvc&#39;</span><span class="p">;</span>
<span class="k">done</span>
</code></pre></div>
<p>You should see PVCs in Bound state. If you want to clean the previously created PVCs:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>sops<span class="w"> </span>exec-file<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml<span class="w"> </span><span class="s1">&#39;kubectl --kubeconfig {} delete pvc rbd-pvc&#39;</span><span class="p">;</span>
<span class="k">done</span>
</code></pre></div>
<h2 id="deploying-compliant-kubernetes-apps">Deploying Compliant Kubernetes Apps<a class="headerlink" href="#deploying-compliant-kubernetes-apps" title="Permanent link">&para;</a></h2>
<p>Now that the Kubernetes clusters are up and running, we are ready to install the Compliant Kubernetes apps.</p>
<h3 id="clone-compliantkubernetes-apps-and-install-pre-requisites">Clone <code>compliantkubernetes-apps</code> and Install Pre-requisites<a class="headerlink" href="#clone-compliantkubernetes-apps-and-install-pre-requisites" title="Permanent link">&para;</a></h3>
<p>If you haven't done so already, clone the <code>compliantkubernetes-apps</code> repo and install pre-requisites.</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/elastisys/compliantkubernetes-apps.git
<span class="nb">cd</span><span class="w"> </span>compliantkubernetes-apps
ansible-playbook<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;ansible_python_interpreter=/usr/bin/python3&#39;</span><span class="w"> </span>--ask-become-pass<span class="w"> </span>--connection<span class="w"> </span><span class="nb">local</span><span class="w"> </span>--inventory<span class="w"> </span><span class="m">127</span>.0.0.1,<span class="w"> </span>get-requirements.yaml
</code></pre></div>
<h3 id="initialize-the-apps-configuration">Initialize the apps configuration<a class="headerlink" href="#initialize-the-apps-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">CK8S_ENVIRONMENT_NAME</span><span class="o">=</span>my-environment-name
<span class="c1">#export CK8S_FLAVOR=[dev|prod] # defaults to dev</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CK8S_CONFIG_PATH</span><span class="o">=</span>~/.ck8s/my-cluster-path
<span class="nb">export</span><span class="w"> </span><span class="nv">CK8S_CLOUD_PROVIDER</span><span class="o">=</span><span class="c1"># [exoscale|safespring|citycloud|aws|baremetal]</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CK8S_PGP_FP</span><span class="o">=</span>&lt;your<span class="w"> </span>GPG<span class="w"> </span>key<span class="w"> </span>fingerprint&gt;<span class="w">  </span><span class="c1"># retrieve with gpg --list-secret-keys</span>

./bin/ck8s<span class="w"> </span>init
</code></pre></div>
<p>This will initialise the configuration in the <code>${CK8S_CONFIG_PATH}</code> directory. Generating configuration files <code>sc-config.yaml</code> and <code>wc-config.yaml</code>, as well as secrets with randomly generated passwords in <code>secrets.yaml</code>. This will also generate read-only default configuration under the directory <code>defaults/</code> which can be used as a guide for available and suggested options.</p>
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-l<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>
</code></pre></div>
<h3 id="configure-the-apps">Configure the apps<a class="headerlink" href="#configure-the-apps" title="Permanent link">&para;</a></h3>
<p>Edit the configuration files <code>${CK8S_CONFIG_PATH}/sc-config.yaml</code>, <code>${CK8S_CONFIG_PATH}/wc-config.yaml</code> and <code>${CK8S_CONFIG_PATH}/secrets.yaml</code> and set the appropriate values for some of the configuration fields.
Note that, the latter is encrypted.</p>
<div class="highlight"><pre><span></span><code>vim<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/sc-config.yaml
vim<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/wc-config.yaml
sops<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/secrets.yaml
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The default configuration for the service cluster and workload cluster are available in the directory <code>${CK8S_CONFIG_PATH}/defaults/</code> and can be used as a reference for available options.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not modify the read-only default configurations files found in the directory <code>${CK8S_CONFIG_PATH}/defaults/</code>. Instead configure the cluster by modifying the regular files <code>${CK8S_CONFIG_PATH}/sc-config.yaml</code> and <code>${CK8S_CONFIG_PATH}/wc-config.yaml</code> as they will override the default options.</p>
</div>
<p>The following are the minimum change you should perform:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ${CK8S_CONFIG_PATH}/sc-config.yaml and ${CK8S_CONFIG_PATH}/wc-config.yaml</span>
<span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="nt">baseDomain</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;set-me&quot;</span><span class="w">  </span><span class="c1"># set to &lt;enovironment_name&gt;.$DOMAIN</span>
<span class="w">  </span><span class="nt">opsDomain</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;set-me&quot;</span><span class="w">  </span><span class="c1"># set to ops.&lt;environment_name&gt;.$DOMAIN</span>
<span class="w">  </span><span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>

<span class="nt">objectStorage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;s3&quot;</span>
<span class="w">  </span><span class="nt">s3</span><span class="p">:</span>
<span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;set-me&quot;</span><span class="w">  </span><span class="c1"># Region for S3 buckets, e.g, west-1</span>
<span class="w">    </span><span class="nt">regionEndpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;set-me&quot;</span><span class="w">  </span><span class="c1"># e.g., https://s3.us-west-1.amazonaws.com</span>

<span class="nt">storageClasses</span><span class="p">:</span>
<span class="w">  </span><span class="nt">default</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph-block</span>
<span class="w">  </span><span class="nt">nfs</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">cinder</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">local</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">ebs</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># ${CK8S_CONFIG_PATH}/sc-config.yaml</span>
<span class="nt">ingressNginx</span><span class="p">:</span>
<span class="w">    </span><span class="nt">controller</span><span class="p">:</span>
<span class="w">      </span><span class="nt">service</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;this-is-not-used&quot;</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;this-is-not-used&quot;</span>

<span class="nt">harbor</span><span class="p">:</span>
<span class="w">  </span><span class="nt">oidc</span><span class="p">:</span>
<span class="w">    </span><span class="nt">groupClaimName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;set-me&quot;</span><span class="w"> </span><span class="c1"># set to group claim name used by OIDC provider</span>

<span class="nt">issuers</span><span class="p">:</span>
<span class="w">  </span><span class="nt">letsencrypt</span><span class="p">:</span>
<span class="w">    </span><span class="nt">prod</span><span class="p">:</span>
<span class="w">      </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;set-me&quot;</span><span class="w">  </span><span class="c1"># set this to an email to receive LetsEncrypt notifications</span>
<span class="w">    </span><span class="nt">staging</span><span class="p">:</span>
<span class="w">      </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;set-me&quot;</span><span class="w">  </span><span class="c1"># set this to an email to receive LetsEncrypt notifications</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># ${CK8S_CONFIG_PATH}/secrets.yaml</span>
<span class="nt">objectStorage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">s3</span><span class="p">:</span>
<span class="w">    </span><span class="nt">accessKey</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;set-me&quot;</span><span class="w"> </span><span class="c1">#set to your s3 accesskey</span>
<span class="w">    </span><span class="nt">secretKey</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;set-me&quot;</span><span class="w"> </span><span class="c1">#set to your s3 secretKey</span>
</code></pre></div>
<h3 id="install-compliant-kubernetes-apps">Install Compliant Kubernetes apps<a class="headerlink" href="#install-compliant-kubernetes-apps" title="Permanent link">&para;</a></h3>
<p>Start with the service cluster:</p>
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span>.yaml<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_sc.yaml
./bin/ck8s<span class="w"> </span>apply<span class="w"> </span>sc<span class="w">  </span><span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
</code></pre></div>
<p>Then the workload clusters:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span>.yaml<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_wc.yaml
<span class="w">    </span>./bin/ck8s<span class="w"> </span>apply<span class="w"> </span>wc<span class="w">  </span><span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
<span class="k">done</span>
</code></pre></div>
<h3 id="settling">Settling<a class="headerlink" href="#settling" title="Permanent link">&para;</a></h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Leave sufficient time for the system to settle, e.g., request TLS certificates from LetsEncrypt, perhaps as much as 20 minutes.</p>
</div>
<p>You can check if the system settled as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>sops<span class="w"> </span>exec-file<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s1">&#39;kubectl --kubeconfig {} get --all-namespaces pods&#39;</span>
<span class="k">done</span>
</code></pre></div>
<p>Check the output of the command above. All Pods needs to be Running or Completed.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>sops<span class="w"> </span>exec-file<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="s1">&#39;kubectl --kubeconfig {} get --all-namespaces issuers,clusterissuers,certificates&#39;</span>
<span class="k">done</span>
</code></pre></div>
<p>Check the output of the command above.
All resources need to have the Ready column True.</p>
<h3 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h3>
<p>After completing the installation step you can test if the apps are properly installed and ready using the commands below.</p>
<p>Start with the service cluster:</p>
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span>.yaml<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_sc.yaml
./bin/ck8s<span class="w"> </span><span class="nb">test</span><span class="w"> </span>sc<span class="w">  </span><span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
</code></pre></div>
<p>Then the workload clusters:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span>.yaml<span class="w"> </span><span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_wc.yaml
<span class="w">    </span>./bin/ck8s<span class="w"> </span><span class="nb">test</span><span class="w"> </span>wc<span class="w">  </span><span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
<span class="k">done</span>
</code></pre></div>
<p>Done.
Navigate to the endpoints, for example <code>grafana.$BASE_DOMAIN</code>, <code>kibana.$BASE_DOMAIN</code>, <code>harbor.$BASE_DOMAIN</code>, etc. to discover Compliant Kubernetes's features.</p>
<h2 id="teardown">Teardown<a class="headerlink" href="#teardown" title="Permanent link">&para;</a></h2>
<h3 id="removing-compliant-kubernetes-apps-from-your-cluster">Removing Compliant Kubernetes Apps from your cluster<a class="headerlink" href="#removing-compliant-kubernetes-apps-from-your-cluster" title="Permanent link">&para;</a></h3>
<p>To remove the applications added by compliant kubernetes you can use the two scripts <code>clean-sc.sh</code> and <code>clean-wc.sh</code>, they are located here in the <a href="https://github.com/elastisys/compliantkubernetes-apps/tree/main/scripts">scripts folder</a>.</p>
<p>They perform the following actions:</p>
<ol>
<li>Delete the added helm charts</li>
<li>Delete the added namespaces</li>
<li>Delete any remaining PersistentVolumes</li>
<li>Delete the added CustomResourceDefinitions</li>
</ol>
<p>Note: if user namespaces are managed by Compliant Kubernetes apps then they will also be deleted if you clean up the workload cluster.</p>
<h3 id="remove-infrastructure">Remove infrastructure<a class="headerlink" href="#remove-infrastructure" title="Permanent link">&para;</a></h3>
<p>To teardown the cluster, please go to the <code>compliantkubernetes-kubespray</code> repo root directory and run the following.</p>
<div class="highlight"><pre><span></span><code><span class="nb">pushd</span><span class="w"> </span>kubespray/contrib/azurerm
<span class="k">for</span><span class="w"> </span>CLUSTER<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>ansible-playbook<span class="w"> </span>generate-templates.yml
<span class="w">    </span>az<span class="w"> </span>group<span class="w"> </span>deployment<span class="w"> </span>create<span class="w"> </span>-g<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CLUSTER</span><span class="s2">&quot;</span><span class="w"> </span>--template-file<span class="w"> </span>./<span class="nv">$CLUSTER</span>/.generated/clear-rg.json<span class="w"> </span>--mode<span class="w"> </span>Complete
<span class="k">done</span>
<span class="nb">popd</span>
</code></pre></div>
<h2 id="further-reading">Further Reading<a class="headerlink" href="#further-reading" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/elastisys/compliantkubernetes-kubespray/blob/main/README.md">Elastisys Compliant Kubernetes Kubespray</a></li>
<li><a href="https://github.com/elastisys/compliantkubernetes-apps">Compliant Kubernetes apps repo</a></li>
<li><a href="https://github.com/elastisys/compliantkubernetes-apps#elastisys-compliant-kubernetes-apps">Configurations option</a></li>
</ul>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2022 Elastisys AB <br/> Kubernetes® is a registered trademark of The Linux Foundation in the United States and other countries, and is used pursuant to a license from The Linux Foundation. <br/> Postgres and PostgreSQL and the Elephant Logo (Slonik) are all registered trademarks of the PostgreSQL Community Association of Canada. <br/> Redis is a trademark of Redis Ltd. Any rights therein are reserved to Redis Ltd. Any use by the Compliant Kubernetes project is for referential purposes only and does not indicate any sponsorship, endorsement or affiliation between Redis and Compliant Kubernetes project. <br/> RabbitMQ is a trademark of VMware, Inc. in the U.S. and other countries. <br/> TimescaleDB and the EON mascot are trademarks of <a href="https://www.timescale.com/">Timescale, Inc.</a> <br/> Jaeger and the Logo are a trademark of The Linux Foundation in the United States and other countries, and is used pursuant to a license from The Linux Foundation.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "toc.integrate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.19047be9.min.js"></script>
      
    
  </body>
</html>