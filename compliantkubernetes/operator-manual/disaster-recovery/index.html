
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Kubernetes platform to comply with Swedish Healthcare (Patientdatalagen), GDPR and ISO 27001." name="description"/>
<meta content="Elastisys AB" name="author"/>
<link href="https://elastisys.io/compliantkubernetes/operator-manual/disaster-recovery/" rel="canonical"/>
<link href="../user-alerts/" rel="prev"/>
<link href="../break-glass/" rel="next"/>
<link href="https://elastisys.io/compliantkubernetes/img/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.5.3, mkdocs-material-9.1.21" name="generator"/>
<title>Disaster Recovery - Elastisys Compliant Kubernetes</title>
<link href="../../assets/stylesheets/main.eebd395e.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.ecc896b0.min.css" rel="stylesheet"/>
<link href="../../stylesheets/branding.css" rel="stylesheet"/>
<link href="../../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://matomo.elastisys.com/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '2']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->
<meta content="website" property="og:type"/>
<meta content="Disaster Recovery - Elastisys Compliant Kubernetes" property="og:title"/>
<meta content="Kubernetes platform to comply with Swedish Healthcare (Patientdatalagen), GDPR and ISO 27001." property="og:description"/>
<meta content="https://elastisys.io/compliantkubernetes/assets/images/social/operator-manual/disaster-recovery.png" property="og:image"/>
<meta content="image/png" property="og:image:type"/>
<meta content="1200" property="og:image:width"/>
<meta content="630" property="og:image:height"/>
<meta content="https://elastisys.io/compliantkubernetes/operator-manual/disaster-recovery/" property="og:url"/>
<meta content="summary_large_image" name="twitter:card"/>
<meta content="Disaster Recovery - Elastisys Compliant Kubernetes" name="twitter:title"/>
<meta content="Kubernetes platform to comply with Swedish Healthcare (Patientdatalagen), GDPR and ISO 27001." name="twitter:description"/>
<meta content="https://elastisys.io/compliantkubernetes/assets/images/social/operator-manual/disaster-recovery.png" name="twitter:image"/>
<meta content="
  default-src 'self';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data:;
  connect-src 'self' https://matomo.elastisys.com/;
  script-src 'self' 'unsafe-inline' https://matomo.elastisys.com/;
" http-equiv="Content-Security-Policy"/>
<!-- Disable localStorage, sessionStorage and cookies -->
<script>
if (window.localStorage) {
  window.localStorage.setItem = function() { };
  window.localStorage.clear();
}
if (window.sessionStorage) {
  window.sessionStorage.setItem = function() { }
  window.sessionStorage.clear();
}
if(!document.__defineGetter__) {
  Object.defineProperty(document, 'cookie', {
    get: function(){return ''},
    set: function(){return true},
  });
} else {
  document.__defineGetter__("cookie", function() { return '';} );
  document.__defineSetter__("cookie", function() {} );
}
</script>
<!-- See https://realfavicongenerator.net -->
<link href="https://elastisys.io/compliantkubernetes/img/apple-touch-icon.png?v=1" rel="apple-touch-icon" sizes="180x180"/>
<link href="https://elastisys.io/compliantkubernetes/img/favicon-32x32.png?v=1" rel="icon" sizes="32x32" type="image/png"/>
<link href="https://elastisys.io/compliantkubernetes/img/favicon-16x16.png?v=1" rel="icon" sizes="16x16" type="image/png"/>
<link href="https://elastisys.io/compliantkubernetes/img/site.webmanifest?v=1" rel="manifest"/>
<link color="#5bbad5" href="https://elastisys.io/compliantkubernetes/img/safari-pinned-tab.svg?v=1" rel="mask-icon"/>
<link href="https://elastisys.io/compliantkubernetes/img/favicon.ico?v=1" rel="shortcut icon"/>
<meta content="#2b5797" name="msapplication-TileColor"/>
<meta content="https://elastisys.io/compliantkubernetes/img/browserconfig.xml?v=1" name="msapplication-config"/>
<meta content="#ffffff" name="theme-color"/>
<link href="../../assets/stylesheets/extra-style.p4jijv9_.min.css" rel="stylesheet"/></head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="elastisys" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#disaster-recovery">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<div data-md-color-scheme="default" data-md-component="outdated" hidden="">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Elastisys Compliant Kubernetes" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Elastisys Compliant Kubernetes">
<img alt="logo" src="../../img/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Elastisys Compliant Kubernetes
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Disaster Recovery
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<ul class="header-links">
<li>
<a href="https://github.com/elastisys/compliantkubernetes/">
<img alt="Git logo" src="../../img/git-alt.svg" width="25px">
</img></a>
</li>
<li><a class="menu-callout" href="https://elastisys.com/">Try out Managed<br/>Compliant Kubernetes</a></li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Elastisys Compliant Kubernetes" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Elastisys Compliant Kubernetes">
<img alt="logo" src="../../img/logo.png"/>
</a>
    Elastisys Compliant Kubernetes
  </label>
<div class="md-nav__source">
<ul class="header-links">
<li>
<a href="https://github.com/elastisys/compliantkubernetes/">
<img alt="Git logo" src="../../img/git-alt.svg" width="25px">
</img></a>
</li>
<li><a class="menu-callout" href="https://elastisys.com/">Try out Managed<br/>Compliant Kubernetes</a></li>
</ul>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        Overview
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          For Application Developers
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          For Application Developers
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_1">
<span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/prepare/">
        Step 1: Prepare
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/deploy/">
        Step 2: Deploy
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/operate/">
        Step 3: Operate
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          Go Deeper
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
          Go Deeper
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/prepare-application/">
        Prepare Your Application
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/prepare-idp/">
        Prepare Your Identity Provider (IdP)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/registry/">
        Container registry
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/continous-development/">
        Continous Development
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/network-model/">
        Network Model
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/kubernetes-api/">
        Kubernetes API
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/kubernetes-ui/">
        Kubernetes UI (Lens)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/namespaces/">
        Namespaces
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/logs/">
        Logs
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/log-based-alerts/">
        Log-based Alerts
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/long-term-log-retention/">
        Long-term Log Retention
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/metrics/">
        Metrics
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/alerts/">
        Metric Alerts
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/maintenance/">
        Maintenance
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/backup/">
        Backups
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/ci-cd/">
        CI/CD
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/demarcation/">
        Demarcation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/delegation/">
        How to Delegate
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/how-many-environments/">
        How many environments?
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          Safeguards
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
          Safeguards
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/safeguards/">
        Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/safeguards/enforce-no-root/">
        Enforce No Root
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/safeguards/enforce-podsecuritypolicies/">
        Enforce Restricted Privileges
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/safeguards/enforce-networkpolicies/">
        Enforce NetworkPolicies
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/safeguards/enforce-resources/">
        Enforce Resources
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/safeguards/enforce-trusted-registries/">
        Enforce Trusted Registries
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/safeguards/enforce-no-latest-tag/">
        Enforce No Latest Tag
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/safeguards/enforce-job-ttl/">
        Enforce Job TTL
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
          Additional Services
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
          Additional Services
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/additional-services/">
        Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/additional-services/postgresql/">
        PostgreSQL
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/additional-services/timescaledb/">
        TimescaleDB
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/additional-services/redis/">
        Redis
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/additional-services/rabbitmq/">
        RabbitMQ
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/additional-services/jaeger/">
        Jaeger (preview)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/additional-services/argocd/">
        Argo CD (preview)
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
          Self-Managed Services
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_5">
<span class="md-nav__icon md-icon"></span>
          Self-Managed Services
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/self-managed-services/ferretdb/">
        FerretDB (self-managed)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/self-managed-services/keycloak/">
        Keycloak (self-managed)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/self-managed-services/jupyterhub/">
        JupyterHub (self-managed)
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/go-live/">
        Go-live Checklist
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/troubleshooting/">
        Troubleshooting
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/faq/">
        FAQ
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          For Platform Administrators
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          For Platform Administrators
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
        Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../getting-started/">
        Getting Started
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../provider-audit/">
        Provider Audit
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../on-prem-standard/">
        Standard Template for on-prem Environment
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../qa/">
        QA
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
          Advanced Configuration
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
          Advanced Configuration
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../configure/">
        Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cluster-sizing/">
        Sizing
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ingress/">
        Ingress
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../access-control/">
        Access Control
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../user-alerts/">
        User Alerts
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Disaster Recovery
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Disaster Recovery
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#compliant-need">
    Compliant Need
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#object-storage-providers">
    Object storage providers
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#off-site-backups">
    Off-site backups
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#when-a-new-regioninfrastructure-provider-is-used">
    When a new region/Infrastructure Provider is used
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#opensearch">
    OpenSearch
  </a>
<nav aria-label="OpenSearch" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#backup">
    Backup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore">
    Restore
  </a>
<nav aria-label="Restore" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#restoring-opensearch-dashboards-data">
    Restoring OpenSearch Dashboards data
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#start-new-cluster-from-snapshot">
    Start new cluster from snapshot
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#harbor">
    Harbor
  </a>
<nav aria-label="Harbor" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#backup_1">
    Backup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore_1">
    Restore
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#velero">
    Velero
  </a>
<nav aria-label="Velero" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#backup_2">
    Backup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore_2">
    Restore
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore-from-off-site-backup">
    Restore from off-site backup
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#grafana">
    Grafana
  </a>
<nav aria-label="Grafana" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#backup_3">
    Backup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore_3">
    Restore
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../break-glass/">
        Breaking the Glass
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cryptography/">
        Use of Cryptography
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../credentials/">
        Use of Credentials
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../capacity-management/">
        Capacity Management
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../clock-synchronization/">
        Clock Synchronization
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../maintenance/">
        Maintenance
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../clean-up/">
        Clean Up
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../troubleshooting/">
        Troubleshooting
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../faq/">
        FAQ
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../additional-services/">
        Additional Services
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          For CISOs and DPOs
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          For CISOs and DPOs
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/">
        Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/controls/iso-27001/">
        ISO 27001
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/controls/hslf-fs-201640/">
        HSLF-FS 2016:40
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/controls/msbfs-20207/">
        MSBFS 2020:7
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/controls/gdpr/">
        GDPR
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/controls/hipaa/">
        HIPAA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/controls/bsi-it-grundschutz/">
        BSI IT-Grundschutz
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/controls/mdr/">
        MDR
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_9" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_9" id="__nav_4_9_label" tabindex="0">
          CISO Dashboards
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_9_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_9">
<span class="md-nav__icon md-icon"></span>
          CISO Dashboards
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/audit-logs/">
        Audit Logs
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/backup/">
        Backup Dashboard
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/cryptography/">
        Cryptography Dashboard
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/intrusion-detection/">
        Intrusion Detection Dashboard
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/policy-as-code/">
        Policy-as-Code Dashboard
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/network-security/">
        Network Security Dashboard
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/capacity-management/">
        Capacity Management (Kubernetes Status) Dashboard
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/vulnerability/">
        Vulnerability Dashboard
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/log-review/">
        Log Review
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/faq/">
        FAQ
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ciso-guide/gdpr-art-17/">
        How do I comply with GDPR Art. 17 Right to erasure ("right to be forgotten")?
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          For Contributors
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
          For Contributors
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../contributor-guide/">
        Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/">
        Architecture
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../adr/">
        Architectural Decision Log
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tech-radar/">
        Tech Radar
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Release Notes
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
          Release Notes
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../release-notes/ck8s/">
        Compliant Kubernetes
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../release-notes/kubespray/">
        CK8S Kubespray
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../release-notes/postgres/">
        CK8S PostgreSQL
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../release-notes/rabbitmq/">
        CK8S RabbitMQ
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../release-notes/redis/">
        CK8S Redis
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../release-notes/jaeger/">
        CK8S Jaeger
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../release-notes/argocd/">
        CK8S Argo CD
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../glossary/">
        Glossary
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../roadmap/">
        Roadmap
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://elastisys.com/">
        Support
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://elastisys.com/training/">
        Training
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://elastisys.com/blog/">
        Blog
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://elastisys.com/legal/privacy-policy/">
        Privacy Policy
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#compliant-need">
    Compliant Need
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#object-storage-providers">
    Object storage providers
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#off-site-backups">
    Off-site backups
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#when-a-new-regioninfrastructure-provider-is-used">
    When a new region/Infrastructure Provider is used
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#opensearch">
    OpenSearch
  </a>
<nav aria-label="OpenSearch" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#backup">
    Backup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore">
    Restore
  </a>
<nav aria-label="Restore" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#restoring-opensearch-dashboards-data">
    Restoring OpenSearch Dashboards data
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#start-new-cluster-from-snapshot">
    Start new cluster from snapshot
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#harbor">
    Harbor
  </a>
<nav aria-label="Harbor" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#backup_1">
    Backup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore_1">
    Restore
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#velero">
    Velero
  </a>
<nav aria-label="Velero" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#backup_2">
    Backup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore_2">
    Restore
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore-from-off-site-backup">
    Restore from off-site backup
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#grafana">
    Grafana
  </a>
<nav aria-label="Grafana" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#backup_3">
    Backup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore_3">
    Restore
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<nav class="md-tags">
<a class="md-tag" href="../../ciso-guide/controls/iso-27001/#iso-27001-a1231-information-backup">ISO 27001 A.12.3.1 Information Backup</a>
<a class="md-tag" href="../../ciso-guide/controls/iso-27001/#iso-27001-a1711-planning-information-security-continuity">ISO 27001 A.17.1.1 Planning Information Security Continuity</a>
<a class="md-tag" href="../../ciso-guide/controls/hipaa/#hipaa-s24-contingency-plan-disaster-recovery-plan-164308a7iib">HIPAA S24 - Contingency Plan - Disaster Recovery Plan - § 164.308(a)(7)(ii)(B)</a>
<a class="md-tag" href="../../ciso-guide/controls/msbfs-20207/#msbfs-20207-4-kap-14">MSBFS 2020:7 4 kap. 14 §</a>
<a class="md-tag" href="../../ciso-guide/controls/msbfs-20207/#msbfs-20207-4-kap-15">MSBFS 2020:7 4 kap. 15 §</a>
<a class="md-tag" href="../../ciso-guide/controls/msbfs-20207/#msbfs-20207-4-kap-22">MSBFS 2020:7 4 kap. 22 §</a>
<a class="md-tag" href="../../ciso-guide/controls/hslf-fs-201640/#hslf-fs-201640-3-kap-13-sakerhetskopiering">HSLF-FS 2016:40 3 kap. 13 § Säkerhetskopiering</a>
</nav>
<h1 id="disaster-recovery">Disaster Recovery<a class="headerlink" href="#disaster-recovery" title="Permanent link">¶</a></h1>
<p>This document details disaster recovery procedures for Compliant Kubernetes. These procedures must be executed by the administrator.</p>
<h2 id="compliant-need">Compliant Need<a class="headerlink" href="#compliant-need" title="Permanent link">¶</a></h2>
<p>Disaster recovery is mandated by several regulations and information security standards. For example, in ISO 27001:2013, the annexes that mostly concerns disaster recovery are:</p>
<ul>
<li><a href="https://www.isms.online/iso-27001/annex-a-12-operations-security/">A.12.3.1 Information Backup</a></li>
<li><a href="https://www.isms.online/iso-27001/annex-a-17-information-security-aspects-of-business-continuity-management/">A.17.1.1 Planning Information Security Continuity</a></li>
</ul>
<h2 id="object-storage-providers">Object storage providers<a class="headerlink" href="#object-storage-providers" title="Permanent link">¶</a></h2>
<h2 id="off-site-backups">Off-site backups<a class="headerlink" href="#off-site-backups" title="Permanent link">¶</a></h2>
<p>Backups can be set up to be replicated off-site using CronJobs.</p>
<p>In version v0.23 these can be <strong>encrypted</strong> before they are sent off-site, which means they must first be restored to be usable. <br/>
It is possible to restore services directly from <strong>unencrypted</strong> off-site backups with some additional steps.</p>
<p>See <a href="https://github.com/elastisys/compliantkubernetes-apps/tree/main/scripts/restore-sync">the instructions in <code>compliantkubernetes-apps</code></a> for how to restore off-site backups.</p>
<h2 id="when-a-new-regioninfrastructure-provider-is-used">When a new region/Infrastructure Provider is used<a class="headerlink" href="#when-a-new-regioninfrastructure-provider-is-used" title="Permanent link">¶</a></h2>
<ul>
<li>Configure and set base ck8s-configs:</li>
</ul>
<p>sc-config.yaml:</p>
<p><code>harbor.persistence.swift.*</code>,<code>objectStorage.sync.*</code></p>
<p>common-config.yaml:</p>
<p><code>objectStorage.s3.region</code>, <code>objectStorage.s3.regionEndpoint</code></p>
<p>secrets.yaml:</p>
<p><code>dex.connectors.*</code>, <code>harbor.persistence.swift.username</code>, <code>harbor.persistence.swift.password</code>, <code>objectStorage.s3.accessKey</code>, <code>objectStorage.s3.secretKey</code></p>
<p>.state/s3cfg.ini:</p>
<p><code>access_key</code>, <code>secret_key</code>, <code>host_base</code>, <code>host_bucket</code></p>
<ul>
<li>Configure and set custom ck8s-configs:</li>
</ul>
<p>Examples can be files containing Identity Provider, Infrastructure Provider, or DNS critical information.</p>
<h2 id="opensearch">OpenSearch<a class="headerlink" href="#opensearch" title="Permanent link">¶</a></h2>
<h3 id="backup">Backup<a class="headerlink" href="#backup" title="Permanent link">¶</a></h3>
<p>OpenSearch is set up to store backups in an S3 bucket. There is a CronJob called <code>opensearch-backup</code> in the cluster that is invoking the snapshot process in OpenSearch.</p>
<p>To take a snapshot on-demand, execute</p>
<div class="highlight"><pre><span></span><code>./bin/ck8s ops kubectl sc -n opensearch-system create job --from=cronjob/opensearch-backup &lt;name-of-job&gt;
</code></pre></div>
<h3 id="restore">Restore<a class="headerlink" href="#restore" title="Permanent link">¶</a></h3>
<p>Set the following variables</p>
<ol>
<li>OpenSearch user with permissions to manage snapshots, usually <code>admin</code></li>
<li>The password for the above user</li>
<li>The URL to OpenSearch</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="nv">user</span><span class="o">=</span>admin
<span class="nv">password</span><span class="o">=</span><span class="k">$(</span>sops<span class="w"> </span>-d<span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/secrets.yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>yq4<span class="w"> </span><span class="s1">'.opensearch.adminPassword'</span><span class="k">)</span>
<span class="nv">os_url</span><span class="o">=</span>https://opensearch.<span class="k">$(</span>yq4<span class="w"> </span><span class="s1">'.global.opsDomain'</span><span class="w"> </span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/common-config.yaml<span class="k">)</span>
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Restoring from off-site backup</p>
<ul>
<li>
<p>To restore from an <strong>encrypted</strong> off-site backup:</p>
<p>First import the backup into the main S3 service and register the restored bucket as a new snapshot repository:
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/_snapshot/backup-repository?pretty"</span><span class="w"> </span>-H<span class="w"> </span><span class="s1">'Content-Type: application/json'</span><span class="w"> </span>-d<span class="s1">'</span>
<span class="s1">{</span>
<span class="s1">  "type": "s3",</span>
<span class="s1">  "settings": {</span>
<span class="s1">    "bucket": "&lt;restored-bucket&gt;",</span>
<span class="s1">    "readonly": true</span>
<span class="s1">  }</span>
<span class="s1">}</span>
<span class="s1">'</span>
</code></pre></div>
Then restore from this snapshot repository (<code>backup-repositroy</code>) in OpenSearch.</p>
</li>
<li>
<p>To restore from an <strong>unencrypted</strong> off-site backup:</p>
<p>Configure the remote and bucket as the main S3 service and bucket for apps and OpenSearch respectively, then update the OpenSearch Helm releases and perform the restore.
It is recommended to either suspend or remove the OpenSearch backup CronJob to prevent it from running while restoring.</p>
<p>Remember to revert to the regular S3 service afterwards and reactivate the backup CronJob! <br/>
Replace the previous snapshot repository if it is unusable.</p>
</li>
</ul>
</div>
<p>List snapshot repositories</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Simple</span>
❯<span class="w"> </span>curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/_cat/repositories?v"</span>
id<span class="w">                   </span><span class="nb">type</span>
opensearch-snapshots<span class="w">   </span>s3

<span class="c1"># Detailed</span>
❯<span class="w"> </span>curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/_snapshot/?pretty"</span>
<span class="o">{</span>
<span class="w">  </span><span class="s2">"opensearch-snapshots"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"s3"</span>,
<span class="w">    </span><span class="s2">"settings"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<span class="w">      </span><span class="s2">"bucket"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"opensearch-backup"</span>,
<span class="w">      </span><span class="s2">"client"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"default"</span>
<span class="w">    </span><span class="o">}</span>
<span class="w">  </span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>List available snapshots</p>
<div class="highlight"><pre><span></span><code><span class="nv">snapshot_repo</span><span class="o">=</span>&lt;name/id<span class="w"> </span>from<span class="w"> </span>previous<span class="w"> </span>step&gt;

<span class="c1"># Simple</span>
❯<span class="w"> </span>curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/_cat/snapshots/</span><span class="si">${</span><span class="nv">snapshot_repo</span><span class="si">}</span><span class="s2">?v&amp;s=id"</span>
id<span class="w">                         </span>status<span class="w"> </span>start_epoch<span class="w"> </span>start_time<span class="w"> </span>end_epoch<span class="w">  </span>end_time<span class="w"> </span>duration<span class="w"> </span>indices<span class="w"> </span>successful_shards<span class="w"> </span>failed_shards<span class="w"> </span>total_shards
snapshot-20211231_120002z<span class="w"> </span>SUCCESS<span class="w"> </span><span class="m">1640952003</span><span class="w">  </span><span class="m">12</span>:00:03<span class="w">   </span><span class="m">1640952082</span><span class="w"> </span><span class="m">12</span>:01:22<span class="w">     </span><span class="m">1</span>.3m<span class="w">      </span><span class="m">54</span><span class="w">                </span><span class="m">54</span><span class="w">             </span><span class="m">0</span><span class="w">           </span><span class="m">54</span>
snapshot-20220101_000003z<span class="w"> </span>SUCCESS<span class="w"> </span><span class="m">1640995203</span><span class="w">  </span><span class="m">00</span>:00:03<span class="w">   </span><span class="m">1640995367</span><span class="w"> </span><span class="m">00</span>:02:47<span class="w">     </span><span class="m">2</span>.7m<span class="w">      </span><span class="m">59</span><span class="w">                </span><span class="m">59</span><span class="w">             </span><span class="m">0</span><span class="w">           </span><span class="m">59</span>
snapshot-20220101_120002z<span class="w"> </span>SUCCESS<span class="w"> </span><span class="m">1641038403</span><span class="w">  </span><span class="m">12</span>:00:03<span class="w">   </span><span class="m">1641038533</span><span class="w"> </span><span class="m">12</span>:02:13<span class="w">     </span><span class="m">2</span>.1m<span class="w">      </span><span class="m">57</span><span class="w">                </span><span class="m">57</span><span class="w">             </span><span class="m">0</span><span class="w">           </span><span class="m">57</span>
...

<span class="c1"># Detailed list of all snapshots</span>
curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/_snapshot/</span><span class="si">${</span><span class="nv">snapshot_repo</span><span class="si">}</span><span class="s2">/_all?pretty"</span>

<span class="c1"># Detailed list of specific snapshot</span>
❯<span class="w"> </span>curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/_snapshot/</span><span class="si">${</span><span class="nv">snapshot_repo</span><span class="si">}</span><span class="s2">/snapshot-20220104_120002z?pretty"</span>
<span class="o">{{</span>
<span class="w">  </span><span class="s2">"snapshots"</span><span class="w"> </span>:<span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="o">{</span>
<span class="w">      </span><span class="s2">"snapshot"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"snapshot-20220104_120002z"</span>,
<span class="w">      </span><span class="s2">"uuid"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"oClQdNAyTeiEmZb5dVh0SQ"</span>,
<span class="w">      </span><span class="s2">"version_id"</span><span class="w"> </span>:<span class="w"> </span><span class="m">135238127</span>,
<span class="w">      </span><span class="s2">"version"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"1.2.3"</span>,
<span class="w">      </span><span class="s2">"indices"</span><span class="w"> </span>:<span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="s2">"authlog-default-2021.12.20-000001"</span>,
<span class="w">        </span><span class="s2">"authlog-default-2021.12.30-000011"</span>,
<span class="w">        </span><span class="s2">"authlog-default-2022.01.03-000015"</span>,
<span class="w">        </span><span class="s2">"other-default-2021.12.30-000011"</span>,
<span class="w">        </span>...
<span class="w">      </span><span class="o">]</span>,
<span class="w">      </span><span class="s2">"data_streams"</span><span class="w"> </span>:<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="o">]</span>,
<span class="w">      </span><span class="s2">"include_global_state"</span><span class="w"> </span>:<span class="w"> </span>false,
<span class="w">      </span><span class="s2">"state"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"SUCCESS"</span>,
<span class="w">      </span><span class="s2">"start_time"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"2022-01-04T12:00:02.596Z"</span>,
<span class="w">      </span><span class="s2">"start_time_in_millis"</span><span class="w"> </span>:<span class="w"> </span><span class="m">1641297602596</span>,
<span class="w">      </span><span class="s2">"end_time"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"2022-01-04T12:01:07.833Z"</span>,
<span class="w">      </span><span class="s2">"end_time_in_millis"</span><span class="w"> </span>:<span class="w"> </span><span class="m">1641297667833</span>,
<span class="w">      </span><span class="s2">"duration_in_millis"</span><span class="w"> </span>:<span class="w"> </span><span class="m">65237</span>,
<span class="w">      </span><span class="s2">"failures"</span><span class="w"> </span>:<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="o">]</span>,
<span class="w">      </span><span class="s2">"shards"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">"total"</span><span class="w"> </span>:<span class="w"> </span><span class="m">66</span>,
<span class="w">        </span><span class="s2">"failed"</span><span class="w"> </span>:<span class="w"> </span><span class="m">0</span>,
<span class="w">        </span><span class="s2">"successful"</span><span class="w"> </span>:<span class="w"> </span><span class="m">66</span>
<span class="w">      </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>
<span class="w">  </span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div>
<p>You usually select the latest snapshot containing the indices you want to restore.
Restore one or multiple indices from a snapshot</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You cannot restore a write index (the latest index) if you already have a write index connected to the same index alias (which will happen if you have started to receive logs).</p>
</div>
<div class="highlight"><pre><span></span><code><span class="nv">snapshot_name</span><span class="o">=</span>&lt;Snapshot<span class="w"> </span>name<span class="w"> </span>from<span class="w"> </span>previous<span class="w"> </span>step&gt;
<span class="c1"># Use "-.*" if index per namespace is enabled</span>
<span class="nv">indices</span><span class="o">=</span><span class="s2">"kubernetes-*,kubeaudit-*,other-*,authlog-*"</span>

curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/_snapshot/</span><span class="si">${</span><span class="nv">snapshot_repo</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">snapshot_name</span><span class="si">}</span><span class="s2">/_restore?pretty"</span><span class="w"> </span>-H<span class="w"> </span><span class="s1">'Content-Type: application/json'</span><span class="w"> </span>-d<span class="s1">'</span>
<span class="s1">{</span>
<span class="s1">  "indices": "'</span><span class="si">${</span><span class="nv">indices</span><span class="si">}</span><span class="s1">'"</span>
<span class="s1">}</span>
<span class="s1">'</span>
</code></pre></div>
<p>Read the <a href="https://opensearch.org/docs/latest/opensearch/snapshot-restore/">documentation</a> to see the API, all parameters and their explanations.</p>
<h4 id="restoring-opensearch-dashboards-data">Restoring OpenSearch Dashboards data<a class="headerlink" href="#restoring-opensearch-dashboards-data" title="Permanent link">¶</a></h4>
<p>Data in OpenSearch Dashboards (saved searches, visualizations, dashboards, etc) is stored in the index <code>.opensearch_dashboards_x</code>. To restore that data you first need to delete the index and then do a restore.</p>
<p>This will overwrite anything in the current <code>.opensearch_dashboards_x</code> index. If there is something new that should be saved, then <a href="https://www.elastic.co/guide/en/kibana/7.10/managing-saved-objects.html#_export">export</a> the saved objects and <a href="https://www.elastic.co/guide/en/kibana/7.10/managing-saved-objects.html#_import">import</a> them after the restore.</p>
<p>There can be multiple <code>.opensearch_dashboards</code> indices in Opensearch, the current index should be the one you want to restore. To view your dashboard indices, follow these steps.</p>
<div class="highlight"><pre><span></span><code><span class="nv">snapshot_name</span><span class="o">=</span>&lt;Snapshot<span class="w"> </span>name<span class="w"> </span>from<span class="w"> </span>previous<span class="w"> </span>step&gt;

curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s1">'/.opensearch_dashboard*?pretty'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">'keys'</span>
</code></pre></div>
<p>If multiple <code>.opensearch_dashboards_x</code> indices show up, run this to see the index that the alias is currently looking at.</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s1">'/_alias/.opensearch_dashboard*?pretty'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">'keys'</span>
</code></pre></div>
<p>Make sure that the index you want to restore also exists on the snapshot. (May be an issue if you are using an old snapshot)</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/_snapshot/</span><span class="si">${</span><span class="nv">snapshot_repo</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">snapshot_name</span><span class="si">}</span><span class="s2">?pretty"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">'.snapshots[].indices'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>.opensearch_dashboards
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you visit the <code>"&lt;os_url&gt;/app/dashboards"</code> page in the Opensearch GUI after deleting the index and before restoring the index, another empty index <code>.opensearch_dashboards</code> will be created. You need to delete this manually, which can be done with
<div class="highlight"><pre><span></span><code><span class="sb">`</span>curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-X<span class="w"> </span>DELETE<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/.opensearch_dashboards?pretty"</span><span class="sb">`</span>
</code></pre></div></p>
</div>
<div class="highlight"><pre><span></span><code><span class="nv">index_to_restore</span><span class="o">=</span>&lt;Index<span class="w"> </span>name<span class="w"> </span>from<span class="w"> </span>previous<span class="w"> </span>step&gt;

curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-X<span class="w"> </span>DELETE<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">index_to_restore</span><span class="si">}</span><span class="s2">?pretty"</span>

curl<span class="w"> </span>-kL<span class="w"> </span>-u<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">os_url</span><span class="si">}</span><span class="s2">/_snapshot/</span><span class="si">${</span><span class="nv">snapshot_repo</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">snapshot_name</span><span class="si">}</span><span class="s2">/_restore?pretty"</span><span class="w"> </span>-H<span class="w"> </span><span class="s1">'Content-Type: application/json'</span><span class="w"> </span>-d<span class="s1">'</span>
<span class="s1">{</span>
<span class="s1">  "indices": "'</span><span class="si">${</span><span class="nv">index_to_restore</span><span class="si">}</span><span class="s1">'"</span>
<span class="s1">}</span>
<span class="s1">'</span>
</code></pre></div>
<h3 id="start-new-cluster-from-snapshot">Start new cluster from snapshot<a class="headerlink" href="#start-new-cluster-from-snapshot" title="Permanent link">¶</a></h3>
<p>This process is very similar to the one described above, but there are a few extra steps to carry out.</p>
<p>Before you install OpenSearch you can preferably disable the initial index creation to make the restore process leaner by setting the following configuration option:</p>
<div class="highlight"><pre><span></span><code>opensearch.createIndices:<span class="w"> </span><span class="nb">false</span>
</code></pre></div>
<p>Install the OpenSearch suite:</p>
<div class="highlight"><pre><span></span><code>./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>helmfile<span class="w"> </span>sc<span class="w"> </span>-l<span class="w"> </span><span class="nv">group</span><span class="o">=</span>opensearch<span class="w"> </span>apply
</code></pre></div>
<p>Wait for the installation to complete.</p>
<p>After the installation, go back up to the <strong>Restore</strong> section to proceed with the restore.
If you want to restore all indices, use the following <code>indices</code> variable</p>
<div class="highlight"><pre><span></span><code><span class="nv">indices</span><span class="o">=</span><span class="s2">"kubernetes-*,kubeaudit-*,other-*,authlog-*"</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This process assumes that you are using the same S3 bucket as your previous cluster. If you aren't:</p>
<ul>
<li>Register a new S3 snapshot repository to the old bucket as <a href="https://opensearch.org/docs/latest/opensearch/snapshot-restore/#register-repository">described here</a></li>
<li>Use the newly registered snapshot repository in the restore process</li>
</ul>
</div>
<h2 id="harbor">Harbor<a class="headerlink" href="#harbor" title="Permanent link">¶</a></h2>
<h3 id="backup_1">Backup<a class="headerlink" href="#backup_1" title="Permanent link">¶</a></h3>
<p>Harbor is set up to store backups of the database in an S3 bucket (note that this does not include the actual images, since those are already stored in S3 by default).
There is a CronJob called <code>harbor-backup-cronjob</code> in the cluster that is taking a database dump and uploading it to a S3 bucket.</p>
<p>To take a backup on-demand, execute</p>
<div class="highlight"><pre><span></span><code>./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>sc<span class="w"> </span>-n<span class="w"> </span>harbor<span class="w"> </span>create<span class="w"> </span>job<span class="w"> </span>--from<span class="o">=</span>cronjob/harbor-backup-cronjob<span class="w"> </span>&lt;name-of-job&gt;
</code></pre></div>
<h3 id="restore_1">Restore<a class="headerlink" href="#restore_1" title="Permanent link">¶</a></h3>
<div class="admonition important">
<p class="admonition-title">Restoring from off-site backup</p>
<p>Since Harbor stores both database backups and images in the same bucket it is recommended to restore the off-site backup into the main S3 service first, reconfigure Harbor to use it, then restore the database from it.</p>
</div>
<p>Instructions for how to restore Harbor can be found in <code>compliantkubernetes-apps</code>: <a href="https://github.com/elastisys/compliantkubernetes-apps/tree/main/scripts/restore#restore-harbor">https://github.com/elastisys/compliantkubernetes-apps/tree/main/scripts/restore#restore-harbor</a></p>
<h2 id="velero">Velero<a class="headerlink" href="#velero" title="Permanent link">¶</a></h2>
<p>These instructions make use of the Velero CLI, you can download it <a href="https://github.com/vmware-tanzu/velero/releases/tag/v1.7.1">here</a> (version 1.7.1).
The CLI needs the env variable <code>KUBECONFIG</code> set to the path of a decrypted kubeconfig.
Read more about Velero <a href="../../user-guide/backup/">here</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This documentation uses the Velero CLI, as opposed to Velero CRDs, since that is what is encouraged by upstream documentation.</p>
</div>
<h3 id="backup_2">Backup<a class="headerlink" href="#backup_2" title="Permanent link">¶</a></h3>
<p>Velero is set up to take daily backups and store them in an S3 bucket.
The daily backup will not take backups of everything in a Kubernetes cluster, it will instead look for certain labels and annotations.
Read more about those labels and annotations <a href="../../user-guide/backup/#backing-up">here</a>.</p>
<p>It is also possible to take on-demand backups.
Then you can freely chose what to backup and do not have to base it on the same labels.
A basic example with the Velero CLI would be <code>velero backup create manual-backup</code>, which would take a backup of all Kubernetes resources (though not the data in the volumes by default).</p>
<p>If you want to create a latest backup from existing schedule , Velero CLI would be <code>velero backup create --from-schedule velero-daily-backup --wait</code>.</p>
<p>Check which arguments you can use by running <code>velero backup create --help</code>.</p>
<h3 id="restore_2">Restore<a class="headerlink" href="#restore_2" title="Permanent link">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are restoring an environment under a new domain name then there is a possibility to reconfigure image references with <a href="https://velero.io/docs/main/restore-reference/#changing-poddeploymentstatefulsetdaemonsetreplicasetreplicationcontrollerjobcronjob-image-repositories">Velero</a>, but ingresses must be updated manually.</p>
</div>
<p>Restoring from a backup with Velero is meant to be a type of disaster recovery.
<strong>Velero will not overwrite existing Resources when restoring.</strong>
As such, if you want to restore the state of a Resource that is still running, the Resource must be deleted first.</p>
<p>To restore the state from the latest daily backup, run:</p>
<div class="highlight"><pre><span></span><code>velero<span class="w"> </span>restore<span class="w"> </span>create<span class="w"> </span>--from-schedule<span class="w"> </span>velero-daily-backup<span class="w"> </span>--wait
</code></pre></div>
<p>This command will wait until the restore has finished.
You can also do partial restorations, e.g. just restoring one namespace, by using different arguments.
You can also restore from manual backups by using the flag <code>--from-backup &lt;backup-name&gt;</code></p>
<p>Persistent Volumes are only restored if a Pod with the backup annotation is restored.
Multiple Pods can have an annotation for the same Persistent Volume.
When restoring the Persistent Volume it will overwrite any existing files with the same names as the files to be restored.
Any other files will be left as they were before the restoration started.
So a restore will not wipe the volume clean and then restore.
If a clean wipe is the desired behavior, then the volume must be wiped manually before restoring.</p>
<h3 id="restore-from-off-site-backup">Restore from off-site backup<a class="headerlink" href="#restore-from-off-site-backup" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>Restoring from <strong>encrypted</strong> off-site backup:</p>
<p>Recover the encrypted bucket into the main S3 service and reconfigure Velero to use this bucket, then follow the regular instructions.</p>
<p>The references in Kubernetes might need to be deleted so Velero can resync from the bucket:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Note that this is only backup metadata</span>
./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>sc<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>delete<span class="w"> </span>backups.velero.io<span class="w"> </span>--all

./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>wc<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>delete<span class="w"> </span>backups.velero.io<span class="w"> </span>--all
</code></pre></div>
</li>
<li>
<p>Restoring from <strong>unencrypted</strong> off-site backup:</p>
<p>To recover directly from off-site backup the backup-location must be reconfigured:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">S3_BUCKET</span><span class="o">=</span><span class="s2">"&lt;off-site-s3-bucket&gt;"</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">S3_PREFIX</span><span class="o">=</span><span class="s2">"&lt;service-cluster|workload-cluster&gt;"</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">S3_ACCESS_KEY</span><span class="o">=</span><span class="k">$(</span>sops<span class="w"> </span>-d<span class="w"> </span>--extract<span class="w"> </span><span class="s1">'["objectStorage"]["sync"]["s3"]["accessKey"]'</span><span class="w"> </span><span class="s2">"</span><span class="nv">$CK8S_CONFIG_PATH</span><span class="s2">/secrets.yaml"</span><span class="k">)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">S3_SECRET_KEY</span><span class="o">=</span><span class="k">$(</span>sops<span class="w"> </span>-d<span class="w"> </span>--extract<span class="w"> </span><span class="s1">'["objectStorage"]["sync"]["s3"]["secretKey"]'</span><span class="w"> </span><span class="s2">"</span><span class="nv">$CK8S_CONFIG_PATH</span><span class="s2">/secrets.yaml"</span><span class="k">)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">S3_REGION</span><span class="o">=</span><span class="k">$(</span>yq<span class="w"> </span>r<span class="w"> </span><span class="s2">"</span><span class="nv">$CK8S_CONFIG_PATH</span><span class="s2">/sc-config.yaml"</span><span class="w"> </span><span class="s2">"objectStorage.sync.s3.region"</span><span class="k">)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">S3_ENDPOINT</span><span class="o">=</span><span class="k">$(</span>yq<span class="w"> </span>r<span class="w"> </span><span class="s2">"</span><span class="nv">$CK8S_CONFIG_PATH</span><span class="s2">/sc-config.yaml"</span><span class="w"> </span><span class="s2">"objectStorage.sync.s3.regionEndpoint"</span><span class="k">)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">S3_PATH_STYLE</span><span class="o">=</span><span class="k">$(</span>yq<span class="w"> </span>r<span class="w"> </span><span class="s2">"</span><span class="nv">$CK8S_CONFIG_PATH</span><span class="s2">/sc-config.yaml"</span><span class="w"> </span><span class="s2">"objectStorage.sync.s3.forcePathStyle"</span><span class="k">)</span>

<span class="c1"># Delete default backup location</span>
velero<span class="w"> </span>backup-location<span class="w"> </span>delete<span class="w"> </span>default

<span class="c1"># Delete backups from default backup location, note that this is only the backup metadata</span>
./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>sc<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>delete<span class="w"> </span>backups.velero.io<span class="w"> </span>--all

./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>wc<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>delete<span class="w"> </span>backups.velero.io<span class="w"> </span>--all

<span class="c1"># Create off-site credentials</span>
kubectl<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>velero-backup<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--from-literal<span class="o">=</span><span class="nv">cloud</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">"[default]\naws_access_key_id: </span><span class="si">${</span><span class="nv">S3_ACCESS_KEY</span><span class="si">}</span><span class="s2">\naws_secret_access_key: </span><span class="si">${</span><span class="nv">S3_SECRET_KEY</span><span class="si">}</span><span class="s2">\n"</span><span class="k">)</span><span class="s2">"</span>

<span class="c1"># Create off-site backup location</span>
velero<span class="w"> </span>backup-location<span class="w"> </span>create<span class="w"> </span>backup<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--access-mode<span class="w"> </span>ReadOnly<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--provider<span class="w"> </span>aws<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--bucket<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">S3_BUCKET</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--prefix<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">S3_PREFIX</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--config<span class="o">=</span><span class="s2">"region=</span><span class="si">${</span><span class="nv">S3_REGION</span><span class="si">}</span><span class="s2">,s3Url=</span><span class="si">${</span><span class="nv">S3_ENDPOINT</span><span class="si">}</span><span class="s2">,s3ForcePathStyle=</span><span class="si">${</span><span class="nv">S3_PATH_STYLE</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--credential<span class="o">=</span>velero-backup<span class="o">=</span>cloud
</code></pre></div>
<p>Check that the backup-location becomes available:
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>velero<span class="w"> </span>backup-location<span class="w"> </span>get
<span class="go">NAME     PROVIDER   BUCKET/PREFIX       PHASE       LAST VALIDATED   ACCESS MODE   DEFAULT</span>
<span class="go">backup   aws        &lt;bucket&gt;/&lt;prefix&gt;   Available   &lt;timestamp&gt;      ReadOnly</span>
</code></pre></div></p>
<p>Then check that the backups becomes available using <code>velero backup get</code>.
When they are available restore one of them using <code>velero restore create &lt;name-of-restore&gt; --from-backup &lt;name-of-backup&gt;</code>.</p>
<p>After the restore is complete Velero should be reconfigured to use the main S3 service again, with a new bucket if the previous one is unusable.
Updating or syncing the Helm chart:
<div class="highlight"><pre><span></span><code>./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>helmfile<span class="w"> </span>sc<span class="w"> </span>-f<span class="w"> </span>helmfile<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>velero<span class="w"> </span>-i<span class="w"> </span>apply

./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>helmfile<span class="w"> </span>wc<span class="w"> </span>-f<span class="w"> </span>helmfile<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>velero<span class="w"> </span>-i<span class="w"> </span>apply
</code></pre></div></p>
<p>The secret and the backup metadata from the off-site backups can be deleted:
<div class="highlight"><pre><span></span><code>./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>sc<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>delete<span class="w"> </span>secret<span class="w"> </span>velero-backup
./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>sc<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>delete<span class="w"> </span>backups.velero.io<span class="w"> </span>--all
./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>sc<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>delete<span class="w"> </span>backupstoragelocations.velero.io<span class="w"> </span>backup

./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>wc<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>delete<span class="w"> </span>secret<span class="w"> </span>velero-backup
./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>wc<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>delete<span class="w"> </span>backups.velero.io<span class="w"> </span>--all
./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>wc<span class="w"> </span>-n<span class="w"> </span>velero<span class="w"> </span>delete<span class="w"> </span>backupstoragelocations.velero.io<span class="w"> </span>backup
</code></pre></div></p>
</li>
</ul>
<h2 id="grafana">Grafana<a class="headerlink" href="#grafana" title="Permanent link">¶</a></h2>
<p>This refers to the user Grafana, not the ops Grafana.</p>
<h3 id="backup_3">Backup<a class="headerlink" href="#backup_3" title="Permanent link">¶</a></h3>
<p>Grafana is set up to be included in the daily Velero backup.
We then include the Grafana deployment, pod, and PVC (including the data).
Manual backups can be taken using velero (include the same resources).</p>
<h3 id="restore_3">Restore<a class="headerlink" href="#restore_3" title="Permanent link">¶</a></h3>
<p>To restore the Grafana backup you must:</p>
<ul>
<li>Have Grafana installed</li>
<li>
<p>Delete the grafana deployment, PVC and PV</p>
<div class="highlight"><pre><span></span><code>./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>sc<span class="w"> </span>delete<span class="w"> </span>deploy<span class="w"> </span>-n<span class="w"> </span>monitoring<span class="w"> </span>user-grafana
./bin/ck8s<span class="w"> </span>ops<span class="w"> </span>kubectl<span class="w"> </span>sc<span class="w"> </span>delete<span class="w"> </span>pvc<span class="w"> </span>-n<span class="w"> </span>monitoring<span class="w"> </span>user-grafana
</code></pre></div>
</li>
<li>
<p>Restore the velero backup</p>
<div class="highlight"><pre><span></span><code>velero<span class="w"> </span>restore<span class="w"> </span>create<span class="w"> </span>--from-schedule<span class="w"> </span>velero-daily-backup<span class="w"> </span>--wait
</code></pre></div>
</li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
            Back to top
          </button>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: User Alerts" class="md-footer__link md-footer__link--prev" href="../user-alerts/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                Previous
              </span>
<div class="md-ellipsis">
                User Alerts
              </div>
</div>
</a>
<a aria-label="Next: Breaking the Glass" class="md-footer__link md-footer__link--next" href="../break-glass/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                Next
              </span>
<div class="md-ellipsis">
                Breaking the Glass
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © Elastisys AB <br/> The Linux Foundation has the following registered trademarks in the United States and/or other countries: Certified Kubernetes®, containerd®, fluentd®, Helm®, Istio®, K8s®, Kubernetes®, Prometheus®, PromQL®, Rook®, The Linux Foundation®. <br/> The Linux Foundation has registrations pending or trademarks in use for the following marks in the United States and/or other countries: Argo™, CoreDNS™, Falco™, Harbor™, Jaeger™, Linux Foundation™, OpenTelemetry™, OpenTracing™, Open Policy Agent™, Tekton™, Thanos™. <br/> Postgres and PostgreSQL and the Elephant Logo (Slonik) are all registered trademarks of the PostgreSQL Community Association of Canada. <br/> Redis is a trademark of Redis Ltd. Any rights therein are reserved to Redis Ltd. Any use by the Compliant Kubernetes project is for referential purposes only and does not indicate any sponsorship, endorsement or affiliation between Redis and Compliant Kubernetes project. <br/> RabbitMQ is a trademark of VMware, Inc. in the U.S. and other countries. <br/> TimescaleDB and the EON mascot are trademarks of <a href="https://www.timescale.com/">Timescale, Inc.</a> <br/> FerretDB® is a registered trademark of FerretDB, Inc. FerretDB Inc. is not affiliated, associated, authorized, endorsed by, or in any way officially connected with MongoDB Inc., or any of its subsidiaries or its affiliates. <br/> MongoDB, Mongo, and the leaf logo are registered trademarks of MongoDB, Inc. <br/> Keycloak™ is a trademark of Red Hat Inc. <br/> OpenSearch is a registered trademark of Amazon Web Services. <br/> NGINX is a registered trademark of F5 Inc.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "navigation.footer", "navigation.top"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
<script src="../../assets/javascripts/bundle.220ee61c.min.js"></script>
</body>
</html>